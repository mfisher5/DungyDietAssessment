geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=20) +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=20) +
labels(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=20) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat <- dat.filter %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
arrange(n_taxon) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(phylum=factor(phylum, levels=phylum))
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=20) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat <- dat.filter %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
arrange(n_taxon) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(phylum=factor(phylum, levels=phylum))
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=20) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=10) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plotdat %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
library(cowplot)
plot1 <- dat.filter %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot2 <- dat.filter %>%
filter(rank=="species") %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique species") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot_grid(plot1,plot2,ncol=2)
plot1 <- dat.filter %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot2 <- dat.filter %>%
filter(rank=="species") %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique species") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot_grid(plot1,plot2,ncol=2)
plot1 <- dat.filter %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique taxa") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot2 <- dat.filter %>%
filter(rank=="species") %>%
group_by(phylum) %>%
summarise(n_crab=length(unique(crab_id)),
n_taxon=length(unique(taxon))) %>%
ggplot(aes(y=n_taxon,x=n_crab, col=phylum)) +
geom_point() +
geom_text_repel(aes(label=phylum), size=3, col="black", max.overlaps=30) +
labs(x="Number of crab",y="Number unique species") +
theme_bw() + theme(axis.text.x=element_text(size=10),
axis.text.y=element_text(size=10),
legend.position="none")
plot_grid(plot1,plot2,ncol=2)
dat.filter %>%
group_by(Site) %>% summarise(length(unique(crab_id)))
dat.filter %>%
group_by(Site) %>% summarise(n_crab=length(unique(crab_id)))
dat.filter %>%
group_by(Site) %>% summarise(`Crab count`=length(unique(crab_id)))
tmpdat <- dat.filter %>%
group_by(Site, crab_id) %>% summarise(nreps=length(unique(Replicate)))
with(tmpdat, table(Site,nreps))
tmpdat <- dat.filter %>%
group_by(Site, crab_id) %>% summarise(nreps=length(unique(Replicate)),.groups = "drop")
with(tmpdat, table(Site,nreps))
site.totals <- dat %>% group_by(Site) %>%
summarise(total_reads=sum(nReads),
total_crab=length(unique(crab_id)))
taxa_summary_bysite <- dat.filter %>%
group_by(taxon, rank, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals,by="site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
taxa_summary_bysite <- dat.filter %>%
group_by(taxon, rank, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
plotdat <- taxa_summary_bysite %>%
dplyr::select(taxon,rank,site,n_crab,prop_crab) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat <- taxa_summary %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=taxon))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(taxon, levels=plotdat$taxon))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=taxon))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat %>%
ggplot(aes(y=n_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labels(x="Crab Count") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon))) %>%
ggplot(aes(y=n_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Crab Count") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon))) %>%
ggplot(aes(y=n_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Crab Count") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat %>%
ggplot(aes(y=n_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(rows=vars(metric),cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Crab Count") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-prop_crab,-n_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat %>%
ggplot(aes(y=n_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Crab Count") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-n_crab,-n_reads) %>%
arrange(prop_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat %>%
ggplot(aes(y=prop_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Prop Crab per Site") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
filter(n_crab > 1) %>%
dplyr::select(-n_crab,-n_reads) %>%
arrange(prop_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(taxon=factor(taxon, levels=unique(taxon)))
plotdat %>%
ggplot(aes(y=prop_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Prop Crab per Site") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat %>%
ggplot(aes(y=prop_crab,x=factor(taxon, levels=unique(plotdat$taxon)))) +
facet_grid(cols=vars(Site),scales="free") +
geom_col(aes(fill=rank)) +
labs(x="Prop Crab per Site") +
ylim(c(0,1)) +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
View(taxa_summary_bysite)
View(taxa_summary)
View(taxa_summary_bysite)
indir
write_csv(taxa_summary_bysite,here(indir, 'lerayXT_r1_taxonomy_summary_by_site.csv'))
write_csv(taxa_summary,here(indir, 'lerayXT_r1_taxonomy_summary.csv'))
taxa_summary_bysite <- dat.filter %>%
filter(rank=="species") %>%
group_by(class, site) %>%
summarise(n_crab=length(unique(sample)),
n_reads=sum(nReads)) %>%
left_join(site.totals,by="site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
taxa_summary_bysite <- dat.filter %>%
filter(rank=="species") %>%
group_by(class, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
site.totals <- dat.filter %>% group_by(Site) %>%
summarise(total_reads=sum(nReads),
total_crab=length(unique(crab_id)))
taxa_summary_bysite <- dat.filter %>%
group_by(taxon, rank, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
site.totals.sp <- dat.filter %>% filter(rank=="species") %>%
group_by(Site) %>%
summarise(total_reads=sum(nReads),
total_crab=length(unique(crab_id)))
taxa_summary_bysite <- dat.filter %>%
filter(rank=="species") %>%
group_by(class, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals.sp,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
taxa_summary_bysite %>%
dplyr::select(class,site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(class, levels=unique(class)))
taxa_summary_bysite %>%
dplyr::select(class,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(class, levels=unique(class)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(class, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
scale_fill_manual(values=c("coral4","coral2"),name="Collection Site") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
dplyr::select(class,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(class, levels=unique(class)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(class, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
scale_fill_manual(values=c("coral4","coral2"),name="Collection Site") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
dplyr::select(class,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(class, levels=unique(class)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(class, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
taxa_summary_bysite <- dat.filter %>%
filter(rank=="species") %>%
group_by(phylum, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals.sp,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
plotdat <- taxa_summary_bysite %>%
dplyr::select(phylum,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(phylum, levels=unique(phylum)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(phylum, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
dplyr::select(phylum,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(phylum, levels=unique(phylum)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(phylum, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
ggtitle("Phyla") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
plotdat <- taxa_summary_bysite %>%
dplyr::select(phylum,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(phylum, levels=unique(phylum)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(phylum, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
ggtitle("Phyla") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
dat.filter %>% filter(is.na(phylum)) %>% pull(taxon) %>% distinct
unique(dat.filter %>% filter(is.na(phylum)) %>% pull(taxon))
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(vegan)
library(magrittr)
# User inputs
indir   <- 'data/blast'
run.num <- 1
marker  <- 'lerayXT'
taxa_summary <- dat.filter %>%
mutate(total_reads=sum(dat.filter$nReads),
total_crab=length(unique((dat.filter$crab_id)))) %>%
group_by(taxon, rank,class,phylum) %>%
summarise(n_crab=length(unique(crab_id)),
prop_crab=n_crab/total_crab,
n_reads=sum(nReads),
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
View(taxa_summary_bysite)
View(taxa_summary)
length(unique(taxa_summary %>% filter(n_crab==1) %>% pull(taxon)))
site.totals.sp <- dat.filter %>% filter(rank=="species") %>%
group_by(Site) %>%
summarise(total_reads=sum(nReads),
total_crab=length(unique(crab_id)))
class_summary_bysite <- dat.filter %>%
filter(rank=="species") %>%
group_by(class, Site) %>%
summarise(n_crab=length(unique(crab_id)),
n_reads=sum(nReads)) %>%
left_join(site.totals.sp,by="Site") %>%
mutate(prop_crab=n_crab/total_crab,
prop_reads=n_reads/total_reads) %>%
distinct() %>% arrange(n_crab)
plotdat <- class_summary_bysite %>%
dplyr::select(class,Site,n_crab,prop_reads) %>%
arrange(n_crab) %>%    # First sort by val. This sort the dataframe but NOT the factor levels
mutate(class=factor(class, levels=unique(class)))
plotdat %>%
pivot_longer(cols=c(n_crab,prop_reads),names_to="metric",values_to="value") %>%
mutate(metric=ifelse(metric=="n_crab","Crab Count","Prop Sequence Reads")) %>%
ggplot(aes(y=value,x=factor(class, levels=unique(plotdat$class)))) +
facet_grid(cols=vars(metric),scales="free") +
geom_col(aes(fill=Site), position="dodge") +
ggtitle("Classes") +
coord_flip() + theme_bw() + theme(axis.title=element_blank(),
strip.text=element_text(size=12),
axis.text.x=element_text(size=12),
axis.text.y=element_text(size=10))
