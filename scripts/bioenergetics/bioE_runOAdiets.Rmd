---
title: "Dungeness crab Bioenergetic - run OA diets"
author: "Kirstin Holsman, Mary Fisher"
output:
  html_document:
    df_print: kable
    fig_caption: yes
    theme: flatly
    toc: true
    toc_float: true
  pdf_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 5
    highlight: tango
    keep_tex: yes
    latex_engine: xelatex
    toc: TRUE
  header-includes:
  - \usepackage{inputenc}
  - \usepackage{unicode-math}
  - \pagenumbering{gobble}
  word_document:
    fig_caption: yes
    fig_width: 4
    keep_md: yes
---

# Description

Compare growth rates of crab with OA diets. 

To Do List:

- check weight calculation in sim_W function -- weight is too high!


```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(janitor)

knitr::opts_chunk$set(echo = TRUE,
                      theme_set(theme_bw()))

dge_dir <- '../../../DungiGraciisBioenergetics'
nrg_dir <- '../../../NRG'
```
```{r Part0, echo=FALSE, warning=FALSE}
  # install.packages("devtools")
  #library("devtools");devtools::install_github("kholsman/NRG")

  #library("NRG")
  #setwd("/Users/kholsman/GitHub/NRG/NRG")

setwd('C:/Users/mfisher5/Documents/NRG')
source("R/make.R")


# source("R/G_fun.R")
# source("R/bioE.R")
# source("R/load_data.R")
# source("R/cuml_curv.R")
# source("R/ftc_fun.R")
# source("R/find_ftcpar.R")
# source("R/hello.R")
# source("R/nrg.R")
# source("R/plot_curve.R")
# source("R/plot_curve3.R")
# source("R/profileT.R")
# source("R/profileW.R")
# source("R/resp_fun.R")
# source("R/rmd2md.R")
# source("R/sim_W.R")
# source("R/simul_ftc.R")
# source("R/ultils.R")
# source("R/waste_fun.R")
source("R/subscripts/molty_IP.R")
source("R/subscripts/molty_MI.R")
source("R/subscripts/crab_afdw.R")
```
<br>

# 1. Getting set up

## 1.1. Parameters

```{r}
parms <- crabPARMS_USE %>% filter(X=="Cmagister"); str(parms)
```
<br>



Note that: 

- Ceq is opt 3,

- Req is opt 0 -- user-specified respiration model. 

<br>
<br>

## 1.2. Data object 

The Dungeness crab data object is saved into NRG. Note that the units in this data / additional parameters all match the units in the parameters object. The respiration function, exuvia energy loss, and proportion I loss are from McDonald et al. (2006). Let's set prey energy density is to be equivalent to predator energy density, representing a 100% cannibalistic diet (!). 
```{r}
str(dcrab_data)

dcrab_data$Eprey <- dcrab_data$Epred
```

<br>

Molting information is also provided as a data frame.  
```{r}
str(dataMOLT$Cmagister)
```

Energy lost to exuvia is modeled as a proportion of body mass. The molt model is set to `1`, which means that molting increment will be based on carapace width (as opposed to degree-days)

<br>

### 1.3. Temperature

For now, use temperature loggers from the intertidal in Willapa Bay, WA. Provided by WSG Crab Team

```{r}
load(here(nrg_dir,'data','WillapaBayTemperature.rds'))
```


Get a daily average temperature
```{r fig.width=4, fig.height=3}
Tdat_raw <- WillapaBayTemperature$WB.oysterville.2021

Tdat <- Tdat_raw %>%
  group_by(date) %>%
  summarise(TempC=mean(TempC))
ggplot() + geom_point(data=Tdat_raw, aes(x=date, y=TempC), col="grey60") +
  geom_path(data=Tdat, aes(x=date,y=TempC, group=1), col="darkred", linewidth=2) 
```
<br>

Then subset the temperature data to run between Jul 1 and October 1.
```{r}
summerTdat <- Tdat %>% filter(ymd(date) < ymd('2021-10-01') & ymd(date) > ymd('2021-07-01'))
```


### 1.4. Test sim_W

Make sure that NRG will work with data given, by running sim_w. 

Set up the simulation with some fake weights
```{r}
nd     <-  dim(summerTdat)[1] # days of simulation
# at start of simulation
Wstart <- 2           

## made up simulation day, weights + date 
Wobs   <- data.frame(
  day = c(1,nd),
  W   = c(Wstart,16)) 
Wobs$date <- summerTdat$date[Wobs$day]

# simulation data
sim_dat       <- dcrab_data
sim_dat$TempC <- summerTdat$TempC     ## temperatures
sim_dat$W     <- Wstart         ## set W data for the simulation to the first observed weight

DCRBdat4sim   <- list(
                  Wtarget  = Wobs,
                  parSIM  = parms,
                  simTdat = summerTdat,
                  dataSIM  = sim_dat,
                  dataMOLT = dataMOLT$Cmagister)

sim_out       <- summerTdat %>% mutate(W=0)
```
```{r}
dcrb.oy.sim <- sim_W(par=0.4, dataIN=DCRBdat4sim, LL=F)
```

```{r echo=FALSE}
plotdat <- data.frame(day=seq(1:(nd+1)),
                      Weight=dcrb.oy.sim$W,
                      Carapace_Width=dcrb.oy.sim$CW) %>%
  pivot_longer(cols=c(2:3), names_to="Metric")
ggplot(plotdat,aes(x=day,y=value)) +
  geom_path() +
  facet_wrap(~Metric, scales="free") + ylab("mm / grams")
```












# 2. Prep Diet Profiles



# 3. Simulate Growth


randomly sample a set of 6 numbers from a normal distribution, and normalize to add to "1". do this 1000 x. These will be the diet proportions. 
```{r}

```
















